# Host Code Generator for Simple OpenCL Kernel Execution

## Author

Andr√© Bannwart Perina

## Introduction

This project can be used to generate host source codes for kernel execution in heterogeneous platforms. By describing kernels and their IOs in an XML file, the C source code for host execution and output validation can be generated quickly and easily. The key feature of the generated source host is that all OpenCL calls are tested for errors and properly reported if anything goes wrong.

## Licence

See LICENSE file.

## Prerequisites

* Python 3;
* Any OpenCL installation (tested with Intel FPGA SDK for OpenCL).

## Downloading the repo

```
$ git clone https://github.com/comododragon/hostcodegen.git
$ git submodule update --init
```

## How to Use (by Example)

There are three examples, vector add (add), vector accumulative add (accadd) and add using vector types (vadd). In the following instructions, simply substitute ```<OP>``` by ```add```, ```accadd``` or ```vadd```.

### Describing your kernel in an XML file

The file ```aocl/src/device.cl``` has an example of kernel for vector add:

```
__kernel void add(__global float * restrict a, __global float * restrict b, __global float * restrict c, __global float * restrict d) {
	int i = get_global_id(0);
	c[i] = a[i] + b[i];
	d[i] += c[i];
}
```

All kernels to be executed by the host must be described on an XML file. An example is present at ```kernelDescriptions/accadd.xml```:

```
<?xml version="1.0" encoding="utf-8"?>
<kernels program="program.aocx" preamble="yes" postamble="yes" looppreamble="yes" looppostamble="yes" cleanup="yes">
	<kernel name="add" order="1">
		<ndrange dim="1">
			<global>10</global>
		</ndrange>
		<input name="a" type="float" nmemb="10" arg="0">9, 8, 7, 6, 5, 4, 3, 2, 1, 0</input>
		<input name="b" type="float" nmemb="10" arg="1" />
		<output name="c" type="float" nmemb="10" arg="2">27, 25, 23, 21, 19, 17, 15, 13, 11, 9</output>
		<output name="d" type="float" nmemb="10" arg="3" />
	</kernel>
</kernels>
```

Descriptions for each tag and attributes are available on the xml files.

### Generating host code

With the XML supplied, we generate the source code:

```
$ python hostCodeGen/hostCodeGen.py kernelDescriptions/<OP>.xml aocl/src/host.c
```

### Compiling and testing (Intel FPGA SDK for OpenCL)

Now it's time to compile and see if everything goes well:

```
$ cd aocl
$ make emu/emulate OP=<op>
```

And finally, run the code:

```
$ cd emu; env CL_CONTEXT_EMULATOR_DEVICE_ALTERA=1 ./emulate; cd ..
```

If everything went well, you should see a list of completed tasks and no messages of incorrect output data. Example for accadd:

```
[ OK ] Calling preamble function...
[ OK ] Getting platforms IDs...
[ OK ] Getting devices IDs for first platform...
[ OK ] Creating context...
[ OK ] Creating command queue for "add"...
[ OK ] Opening program binary...
[ OK ] Reading program binary...
[ OK ] Creating program from binary...
[ OK ] Building program...
[ OK ] Creating kernel "add" from program...
[ OK ] Creating buffers...
[ OK ] Setting kernel arguments for "add"...
[ OK ] [0] Calling loop preamble function...
[ OK ] [0] Setting buffers...
[ OK ] [0] Running kernels...
[ OK ] [0] Getting kernels arguments...
[ OK ] [0] Calling loop postamble function...
[ OK ] [1] Calling loop preamble function...
[ OK ] [1] Setting buffers...
[ OK ] [1] Running kernels...
[ OK ] [1] Getting kernels arguments...
[ OK ] [1] Calling loop postamble function...
[ OK ] [2] Calling loop preamble function...
[ OK ] [2] Setting buffers...
[ OK ] [2] Running kernels...
[ OK ] [2] Getting kernels arguments...
[ OK ] [2] Calling loop postamble function...
[ OK ] Calling postamble function...
[ OK ] Validating received data...
```

If output data is different from the expected values, the host code will inform it:

```
[ OK ] Calling preamble function...
[ OK ] Getting platforms IDs...
[ OK ] Getting devices IDs for first platform...
[ OK ] Creating context...
[ OK ] Creating command queue for "add"...
[ OK ] Opening program binary...
[ OK ] Reading program binary...
[ OK ] Creating program from binary...
[ OK ] Building program...
[ OK ] Creating kernel "add" from program...
[ OK ] Creating buffers...
[ OK ] Setting kernel arguments for "add"...
[ OK ] [0] Calling loop preamble function...
[ OK ] [0] Setting buffers...
[ OK ] [0] Running kernels...
[ OK ] [0] Getting kernels arguments...
[ OK ] [0] Calling loop postamble function...
[ OK ] [1] Calling loop preamble function...
[ OK ] [1] Setting buffers...
[ OK ] [1] Running kernels...
[ OK ] [1] Getting kernels arguments...
[ OK ] [1] Calling loop postamble function...
[ OK ] [2] Calling loop preamble function...
[ OK ] [2] Setting buffers...
[ OK ] [2] Running kernels...
[ OK ] [2] Getting kernels arguments...
[ OK ] [2] Calling loop postamble function...
[ OK ] Calling postamble function...
[FAIL] Validating received data...
Variable c[4]: expected 20.000000 got 19.000000.
Variable c[5]: expected 19.000000 got 17.000000.
Variable c[6]: expected 16.000000 got 15.000000.
```

## Repository structure

* ```aocl```: Intel FPGA SDK for OpenCL project
	* ```bin```: folder where host binary and kernel files are stored for actual execution on FPGA
	* ```emu```: folder where host binary and kernel files are stored for emulation
	* ```include```: header files for host and kernel compilation
		* ```accadd```: header files for accumulative add operation
			* ```prepostambles.h```: pre/postamble definitions for accumulative add
		* ```add```: header files for simple add operation
			* ```prepostambles.h```: pre/postamble definitions for simple add
		* ```vadd```: header files for simple add operation using vector types
			* ```prepostambles.h```: pre/postamble definitions for simple add using vector types
	* ```src```: source files
		* ```host.c```: file generated by our tool
		* ```device.cl```: simple kernel example for add and accadd
		* ```device2.cl```: simple kernel example for add using vector types
	* ```Makefile```: simple makefile for compiling host and kernel codes
* ```hostCodeGen```: code generator project
	* ```codeemitter.py```: python class responsible for emitting sections of C codes
	* ```hostCodeGen.py```: main program
* ```kernelDescriptions```:
	* ```accadd.xml```: simple descriptor (accumulative add) for the kernel available in ```aocl/src/device.cl```
	* ```add.xml```: simple descriptor (add) for the kernel available in ```aocl/src/device.cl```
	* ```vadd.xml```: simple descriptor (add with vector types) for the kernel available in ```aocl/src/device2.cl```
