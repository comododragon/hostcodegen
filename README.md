# Host Code Generator for Simple OpenCL Kernel Execution

## Author

Andr√© Bannwart Perina

## Introduction

This project can be used to generate host source codes for kernel execution in heterogeneous platforms. By describing kernels and their IOs in an XML file, the C source code for host execution and output validation can be generated quickly and easily. The key feature of the generated source host is that all OpenCL calls are tested for errors and properly reported if anything goes wrong.

## Licence

See LICENSE file.

## Prerequisites

* Python 3;
* Any OpenCL installation (tested with Intel FPGA SDK for OpenCL).

## Downloading the repo

```
$ git clone https://github.com/comododragon/hostcodegen.git
$ git submodule update --init
```

## How to Use (by Example)

#### Describing your kernel in an XML file

The file ```aocl/src/device.cl``` has an example of kernel for vector add:

```
__kernel void add(__global float * restrict a, __global float * restrict b, __global float * restrict c) {
	int i = get_global_id(0);
	c[i] = a[i] + b[i];
}
```

All kernels to be executed by the host must be described on an XML file. An example is present at ```kernelDescriptions/add.xml```:

```
<?xml version="1.0" encoding="utf-8"?>
<kernels repeat="5" program="program.aocx">
	<kernel name="add" order="1">
		<ndrange dim="1">
			<global>50</global>
		</ndrange>
		<input name="a" type="float" nmemb="10" arg="0">9, 8, 7, 6, 5, 4, 3, 2, 1, 0</input>
		<input name="b" type="float" nmemb="10" function="fillb" arg="1" />
		<output name="c" type="float" nmemb="10" arg="2">9, 9, 9, 9, 9, 9, 9, 9, 9, 9</output>
	</kernel>
</kernels>
```

Descriptions for each tag and attributes are available on the file itself.

#### Generating host code

With the XML supplied, we generate the source code:

```
$ python hostCodeGen/hostCodeGen.py kernelDescriptions/add.xml aocl/src/host.c
```

#### Compiling and testing (Intel FPGA SDK for OpenCL)

Now it's time to compile and see if everything goes well:

```
$ cd aocl
$ make emu/emulate
```

And finally, run the code:

```
$ cd emu; env CL_CONTEXT_EMULATOR_DEVICE_ALTERA=1 ./emulate; cd ..
```

If everything went well, you should see a list of completed tasks and no messages of incorrect output data:

```
[ OK ] Getting platforms IDs...
[ OK ] Getting devices IDs for first platform...
[ OK ] Creating context...
[ OK ] Creating command queue for "add"...
[ OK ] Opening program binary...
[ OK ] Reading program binary...
[ OK ] Creating program from binary...
[ OK ] Building program...
[ OK ] Creating kernel "add" from program...
[ OK ] Creating and setting buffers...
[ OK ] Setting kernel arguments for "add"...
[ OK ] Running kernels...
[ OK ] Getting kernels arguments...
[ OK ] Validating received data...
```

If output data is different from the expected values, the host code will inform it:

```
[ OK ] Getting platforms IDs...
[ OK ] Getting devices IDs for first platform...
[ OK ] Creating context...
[ OK ] Creating command queue for "add"...
[ OK ] Opening program binary...
[ OK ] Reading program binary...
[ OK ] Creating program from binary...
[ OK ] Building program...
[ OK ] Creating kernel "add" from program...
[ OK ] Creating and setting buffers...
[ OK ] Setting kernel arguments for "add"...
[ OK ] Running kernels...
[ OK ] Getting kernels arguments...
[FAIL] Validating received data...
Variable c[0]: Expected bb73e740 got bb47c3dd.
```

## Repository structure

* ```aocl```: Intel FPGA SDK for OpenCL project
	* ```bin```: Folder where host binary and kernel files are stored for actual execution on FPGA;
	* ```emu```: Folder where host binary and kernel files are stored for emulation;
	* ```include```: Header files for host and kernel compilation;
	* ```src```: Source files
		* ```host.c```: File generated by our tool;
		* ```device.cl```: Simple kernel example;
	* Makefile: Simple makefile for compiling host and kernel codes;
* ```hostCodeGen```: Code generator project
	* ```codeemitter.py```: Python class responsible for emitting sections of C codes;
	* ```hostCodeGen.py```: Main program;
* ```kernelDescriptions```:
	* ```add.xml```: Simple descriptor for the kernel available in ```aocl/src/device.cl```.
